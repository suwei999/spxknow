# 中间件服务使用指南

## 📋 概述

本指南介绍如何使用独立的中间件服务Docker Compose配置。

**文件**: `docker-compose.middleware.yml`  
**包含服务**: MySQL, MinIO, Redis, OpenSearch  
**不包含**: 前后端应用

---

## 🚀 快速开始

### 1. 启动所有中间件服务

```bash
# 进入项目目录
cd spx-knowledge-backend

# 使用中间件专用配置文件启动
docker-compose -f docker/docker-compose.middleware.yml --env-file .env.middleware up -d
```

### 2. 查看服务状态

```bash
docker-compose -f docker/docker-compose.middleware.yml ps
```

### 3. 查看日志

```bash
# 查看所有服务日志
docker-compose -f docker/docker-compose.middleware.yml logs -f

# 查看单个服务日志
docker-compose -f docker/docker-compose.middleware.yml logs -f mysql
docker-compose -f docker/docker-compose.middleware.yml logs -f redis
docker-compose -f docker/docker-compose.middleware.yml logs -f minio
docker-compose -f docker/docker-compose.middleware.yml logs -f opensearch
```

### 4. 停止服务

```bash
docker-compose -f docker/docker-compose.middleware.yml down
```

### 5. 停止并删除数据卷

```bash
docker-compose -f docker/docker-compose.middleware.yml down -v
```

---

## 📊 服务详情

### 1. MySQL 数据库

**容器名**: `spx-knowledge-mysql`  
**端口**: 3306  
**健康检查**: 每10秒检查一次

**环境变量**:
- `MYSQL_ROOT_PASSWORD`: root用户密码
- `MYSQL_DATABASE`: 数据库名
- `MYSQL_USER`: 普通用户
- `MYSQL_PASSWORD`: 普通用户密码

**数据持久化**: `mysql_data` volume

**初始化**: 自动执行 `init.sql`

**连接示例**:
```bash
mysql -h 127.0.0.1 -P 3306 -u spxuser -p
# 密码: spxpass123
```

---

### 2. MinIO 对象存储

**容器名**: `spx-knowledge-minio`  
**API端口**: 9000  
**控制台端口**: 9001  
**健康检查**: 每30秒检查一次

**环境变量**:
- `MINIO_ROOT_USER`: 管理员用户名
- `MINIO_ROOT_PASSWORD`: 管理员密码

**控制台地址**: http://localhost:9001

**默认登录**:
- Username: `minioadmin`
- Password: `minioadmin`

**创建Bucket**:
```bash
# 访问控制台 http://localhost:9001
# 创建名为 spx-knowledge 的bucket
```

**连接配置**:
```python
MINIO_ENDPOINT = "localhost:9000"
MINIO_ROOT_USER = "minioadmin"
MINIO_ROOT_PASSWORD = "minioadmin"
MINIO_BUCKET_NAME = "spx-knowledge"
MINIO_USE_SSL = False
```

---

### 3. Redis 缓存

**容器名**: `spx-knowledge-redis`  
**端口**: 6379  
**健康检查**: 每10秒检查一次

**数据持久化**: 
- RDB: 自动保存
- AOF: 每秒同步
- `redis_data` volume

**内存配置**:
- 最大内存: 512MB
- 淘汰策略: allkeys-lru

**连接示例**:
```bash
redis-cli -h 127.0.0.1 -p 6379
```

**连接配置**:
```python
REDIS_HOST = "localhost"
REDIS_PORT = 6379
REDIS_PASSWORD = None
REDIS_DB = 0
```

---

### 4. OpenSearch 搜索引擎

**容器名**: `spx-knowledge-opensearch`  
**HTTP端口**: 9200  
**Transport端口**: 9300  
**健康检查**: 每30秒检查一次

**内存配置**: 512MB (可通过环境变量调整)

**禁用安全插件**: 开发环境已禁用

**连接示例**:
```bash
curl http://localhost:9200/_cluster/health
```

**连接配置**:
```python
OPENSEARCH_HOSTS = ["http://localhost:9200"]
OPENSEARCH_USER = None
OPENSEARCH_PASSWORD = None
OPENSEARCH_USE_SSL = False
OPENSEARCH_VERIFY_CERTS = False
```

---

### 5. OpenSearch Dashboards

**容器名**: `spx-knowledge-opensearch-dashboards`  
**端口**: 5601

**访问地址**: http://localhost:5601

**功能**: 
- 可视化查询OpenSearch数据
- 监控索引状态
- 调试搜索查询

---

## 🔧 配置说明

### 端口映射

| 服务 | 容器端口 | 主机端口 | 说明 |
|------|---------|---------|------|
| MySQL | 3306 | 3306 | 数据库 |
| MinIO API | 9000 | 9000 | 对象存储API |
| MinIO Console | 9001 | 9001 | 管理控制台 |
| Redis | 6379 | 6379 | 缓存 |
| OpenSearch | 9200 | 9200 | 搜索API |
| OpenSearch Transport | 9300 | 9300 | 集群通信 |
| OpenSearch Dashboards | 5601 | 5601 | 可视化界面 |

### 数据卷

| Volume名称 | 挂载路径 | 说明 |
|-----------|---------|------|
| mysql_data | /var/lib/mysql | MySQL数据 |
| minio_data | /data | MinIO对象数据 |
| redis_data | /data | Redis数据 |
| opensearch_data | /usr/share/opensearch/data | OpenSearch索引 |
| opensearch_dashboards_data | /usr/share/opensearch-dashboards/data | Dashboards配置 |

---

## ✅ 健康检查

所有服务都配置了健康检查：

### MySQL
```bash
docker inspect spx-knowledge-mysql | grep Health -A 10
```

### Redis
```bash
docker inspect spx-knowledge-redis | grep Health -A 10
```

### MinIO
```bash
docker inspect spx-knowledge-minio | grep Health -A 10
```

### OpenSearch
```bash
docker inspect spx-knowledge-opensearch | grep Health -A 10
```

---

## 🛠️ 常见问题

### 1. 端口被占用

**问题**: 启动时报端口已被占用

**解决**:
```bash
# 修改 .env.middleware 文件中的端口号
# 或者停止占用端口的服务
```

### 2. MySQL初始化失败

**问题**: init.sql执行失败

**解决**:
```bash
# 检查 init.sql 文件是否存在
# 查看日志
docker-compose -f docker/docker-compose.middleware.yml logs mysql
```

### 3. 内存不足

**问题**: OpenSearch启动失败

**解决**:
```bash
# 增加Docker内存限制
# 或在 .env.middleware 中调整 OPENSEARCH_JAVA_OPTS
# 例如: OPENSEARCH_JAVA_OPTS=-Xms256m -Xmx256m
```

### 4. MinIO访问被拒绝

**问题**: 控制台无法访问

**解决**:
```bash
# 检查防火墙设置
# 确保端口9001已开放
# Windows: netsh advfirewall firewall add rule name="MinIO" dir=in action=allow protocol=TCP localport=9001
```

---

## 📝 使用建议

### 开发环境

1. ✅ 使用独立中间件，不依赖完整系统
2. ✅ 前后端可以本地运行，连接这些中间件
3. ✅ 便于调试和测试

### 生产环境

1. ⚠️ 建议使用独立的中间件集群
2. ⚠️ 配置更强的安全策略
3. ⚠️ 启用TLS/SSL
4. ⚠️ 配置定期备份

---

## 🔄 与完整系统的整合

启动中间件后，前后端应用需要配置连接到这些服务：

```python
# 后端配置 (spx-knowledge-backend/.env)

# MySQL
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=user
MYSQL_PASSWORD=password
MYSQL_DATABASE=spx_knowledge

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# MinIO
MINIO_ENDPOINT=localhost:9000
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin

# OpenSearch
OPENSEARCH_HOSTS=["http://localhost:9200"]
```

---

**文档版本**: 1.0  
**更新日期**: 2024年1月

