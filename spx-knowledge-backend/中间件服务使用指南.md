# ä¸­é—´ä»¶æœåŠ¡ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä½¿ç”¨ç‹¬ç«‹çš„ä¸­é—´ä»¶æœåŠ¡Docker Composeé…ç½®ã€‚

**æ–‡ä»¶**: `docker-compose.middleware.yml`  
**åŒ…å«æœåŠ¡**: MySQL, MinIO, Redis, OpenSearch  
**ä¸åŒ…å«**: å‰åç«¯åº”ç”¨

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨æ‰€æœ‰ä¸­é—´ä»¶æœåŠ¡

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd spx-knowledge-backend

# ä½¿ç”¨ä¸­é—´ä»¶ä¸“ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨
docker-compose -f docker/docker-compose.middleware.yml --env-file .env.middleware up -d
```

### 2. æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
docker-compose -f docker/docker-compose.middleware.yml ps
```

### 3. æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose -f docker/docker-compose.middleware.yml logs -f

# æŸ¥çœ‹å•ä¸ªæœåŠ¡æ—¥å¿—
docker-compose -f docker/docker-compose.middleware.yml logs -f mysql
docker-compose -f docker/docker-compose.middleware.yml logs -f redis
docker-compose -f docker/docker-compose.middleware.yml logs -f minio
docker-compose -f docker/docker-compose.middleware.yml logs -f opensearch
```

### 4. åœæ­¢æœåŠ¡

```bash
docker-compose -f docker/docker-compose.middleware.yml down
```

### 5. åœæ­¢å¹¶åˆ é™¤æ•°æ®å·

```bash
docker-compose -f docker/docker-compose.middleware.yml down -v
```

---

## ğŸ“Š æœåŠ¡è¯¦æƒ…

### 1. MySQL æ•°æ®åº“

**å®¹å™¨å**: `spx-knowledge-mysql`  
**ç«¯å£**: 3306  
**å¥åº·æ£€æŸ¥**: æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡

**ç¯å¢ƒå˜é‡**:
- `MYSQL_ROOT_PASSWORD`: rootç”¨æˆ·å¯†ç 
- `MYSQL_DATABASE`: æ•°æ®åº“å
- `MYSQL_USER`: æ™®é€šç”¨æˆ·
- `MYSQL_PASSWORD`: æ™®é€šç”¨æˆ·å¯†ç 

**æ•°æ®æŒä¹…åŒ–**: `mysql_data` volume

**åˆå§‹åŒ–**: è‡ªåŠ¨æ‰§è¡Œ `init.sql`

**è¿æ¥ç¤ºä¾‹**:
```bash
mysql -h 127.0.0.1 -P 3306 -u spxuser -p
# å¯†ç : spxpass123
```

---

### 2. MinIO å¯¹è±¡å­˜å‚¨

**å®¹å™¨å**: `spx-knowledge-minio`  
**APIç«¯å£**: 9000  
**æ§åˆ¶å°ç«¯å£**: 9001  
**å¥åº·æ£€æŸ¥**: æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡

**ç¯å¢ƒå˜é‡**:
- `MINIO_ROOT_USER`: ç®¡ç†å‘˜ç”¨æˆ·å
- `MINIO_ROOT_PASSWORD`: ç®¡ç†å‘˜å¯†ç 

**æ§åˆ¶å°åœ°å€**: http://localhost:9001

**é»˜è®¤ç™»å½•**:
- Username: `minioadmin`
- Password: `minioadmin`

**åˆ›å»ºBucket**:
```bash
# è®¿é—®æ§åˆ¶å° http://localhost:9001
# åˆ›å»ºåä¸º spx-knowledge çš„bucket
```

**è¿æ¥é…ç½®**:
```python
MINIO_ENDPOINT = "localhost:9000"
MINIO_ROOT_USER = "minioadmin"
MINIO_ROOT_PASSWORD = "minioadmin"
MINIO_BUCKET_NAME = "spx-knowledge"
MINIO_USE_SSL = False
```

---

### 3. Redis ç¼“å­˜

**å®¹å™¨å**: `spx-knowledge-redis`  
**ç«¯å£**: 6379  
**å¥åº·æ£€æŸ¥**: æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡

**æ•°æ®æŒä¹…åŒ–**: 
- RDB: è‡ªåŠ¨ä¿å­˜
- AOF: æ¯ç§’åŒæ­¥
- `redis_data` volume

**å†…å­˜é…ç½®**:
- æœ€å¤§å†…å­˜: 512MB
- æ·˜æ±°ç­–ç•¥: allkeys-lru

**è¿æ¥ç¤ºä¾‹**:
```bash
redis-cli -h 127.0.0.1 -p 6379
```

**è¿æ¥é…ç½®**:
```python
REDIS_HOST = "localhost"
REDIS_PORT = 6379
REDIS_PASSWORD = None
REDIS_DB = 0
```

---

### 4. OpenSearch æœç´¢å¼•æ“

**å®¹å™¨å**: `spx-knowledge-opensearch`  
**HTTPç«¯å£**: 9200  
**Transportç«¯å£**: 9300  
**å¥åº·æ£€æŸ¥**: æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡

**å†…å­˜é…ç½®**: 512MB (å¯é€šè¿‡ç¯å¢ƒå˜é‡è°ƒæ•´)

**ç¦ç”¨å®‰å…¨æ’ä»¶**: å¼€å‘ç¯å¢ƒå·²ç¦ç”¨

**è¿æ¥ç¤ºä¾‹**:
```bash
curl http://localhost:9200/_cluster/health
```

**è¿æ¥é…ç½®**:
```python
OPENSEARCH_HOSTS = ["http://localhost:9200"]
OPENSEARCH_USER = None
OPENSEARCH_PASSWORD = None
OPENSEARCH_USE_SSL = False
OPENSEARCH_VERIFY_CERTS = False
```

---

### 5. OpenSearch Dashboards

**å®¹å™¨å**: `spx-knowledge-opensearch-dashboards`  
**ç«¯å£**: 5601

**è®¿é—®åœ°å€**: http://localhost:5601

**åŠŸèƒ½**: 
- å¯è§†åŒ–æŸ¥è¯¢OpenSearchæ•°æ®
- ç›‘æ§ç´¢å¼•çŠ¶æ€
- è°ƒè¯•æœç´¢æŸ¥è¯¢

---

## ğŸ”§ é…ç½®è¯´æ˜

### ç«¯å£æ˜ å°„

| æœåŠ¡ | å®¹å™¨ç«¯å£ | ä¸»æœºç«¯å£ | è¯´æ˜ |
|------|---------|---------|------|
| MySQL | 3306 | 3306 | æ•°æ®åº“ |
| MinIO API | 9000 | 9000 | å¯¹è±¡å­˜å‚¨API |
| MinIO Console | 9001 | 9001 | ç®¡ç†æ§åˆ¶å° |
| Redis | 6379 | 6379 | ç¼“å­˜ |
| OpenSearch | 9200 | 9200 | æœç´¢API |
| OpenSearch Transport | 9300 | 9300 | é›†ç¾¤é€šä¿¡ |
| OpenSearch Dashboards | 5601 | 5601 | å¯è§†åŒ–ç•Œé¢ |

### æ•°æ®å·

| Volumeåç§° | æŒ‚è½½è·¯å¾„ | è¯´æ˜ |
|-----------|---------|------|
| mysql_data | /var/lib/mysql | MySQLæ•°æ® |
| minio_data | /data | MinIOå¯¹è±¡æ•°æ® |
| redis_data | /data | Redisæ•°æ® |
| opensearch_data | /usr/share/opensearch/data | OpenSearchç´¢å¼• |
| opensearch_dashboards_data | /usr/share/opensearch-dashboards/data | Dashboardsé…ç½® |

---

## âœ… å¥åº·æ£€æŸ¥

æ‰€æœ‰æœåŠ¡éƒ½é…ç½®äº†å¥åº·æ£€æŸ¥ï¼š

### MySQL
```bash
docker inspect spx-knowledge-mysql | grep Health -A 10
```

### Redis
```bash
docker inspect spx-knowledge-redis | grep Health -A 10
```

### MinIO
```bash
docker inspect spx-knowledge-minio | grep Health -A 10
```

### OpenSearch
```bash
docker inspect spx-knowledge-opensearch | grep Health -A 10
```

---

## ğŸ› ï¸ å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨

**é—®é¢˜**: å¯åŠ¨æ—¶æŠ¥ç«¯å£å·²è¢«å ç”¨

**è§£å†³**:
```bash
# ä¿®æ”¹ .env.middleware æ–‡ä»¶ä¸­çš„ç«¯å£å·
# æˆ–è€…åœæ­¢å ç”¨ç«¯å£çš„æœåŠ¡
```

### 2. MySQLåˆå§‹åŒ–å¤±è´¥

**é—®é¢˜**: init.sqlæ‰§è¡Œå¤±è´¥

**è§£å†³**:
```bash
# æ£€æŸ¥ init.sql æ–‡ä»¶æ˜¯å¦å­˜åœ¨
# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker/docker-compose.middleware.yml logs mysql
```

### 3. å†…å­˜ä¸è¶³

**é—®é¢˜**: OpenSearchå¯åŠ¨å¤±è´¥

**è§£å†³**:
```bash
# å¢åŠ Dockerå†…å­˜é™åˆ¶
# æˆ–åœ¨ .env.middleware ä¸­è°ƒæ•´ OPENSEARCH_JAVA_OPTS
# ä¾‹å¦‚: OPENSEARCH_JAVA_OPTS=-Xms256m -Xmx256m
```

### 4. MinIOè®¿é—®è¢«æ‹’ç»

**é—®é¢˜**: æ§åˆ¶å°æ— æ³•è®¿é—®

**è§£å†³**:
```bash
# æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
# ç¡®ä¿ç«¯å£9001å·²å¼€æ”¾
# Windows: netsh advfirewall firewall add rule name="MinIO" dir=in action=allow protocol=TCP localport=9001
```

---

## ğŸ“ ä½¿ç”¨å»ºè®®

### å¼€å‘ç¯å¢ƒ

1. âœ… ä½¿ç”¨ç‹¬ç«‹ä¸­é—´ä»¶ï¼Œä¸ä¾èµ–å®Œæ•´ç³»ç»Ÿ
2. âœ… å‰åç«¯å¯ä»¥æœ¬åœ°è¿è¡Œï¼Œè¿æ¥è¿™äº›ä¸­é—´ä»¶
3. âœ… ä¾¿äºè°ƒè¯•å’Œæµ‹è¯•

### ç”Ÿäº§ç¯å¢ƒ

1. âš ï¸ å»ºè®®ä½¿ç”¨ç‹¬ç«‹çš„ä¸­é—´ä»¶é›†ç¾¤
2. âš ï¸ é…ç½®æ›´å¼ºçš„å®‰å…¨ç­–ç•¥
3. âš ï¸ å¯ç”¨TLS/SSL
4. âš ï¸ é…ç½®å®šæœŸå¤‡ä»½

---

## ğŸ”„ ä¸å®Œæ•´ç³»ç»Ÿçš„æ•´åˆ

å¯åŠ¨ä¸­é—´ä»¶åï¼Œå‰åç«¯åº”ç”¨éœ€è¦é…ç½®è¿æ¥åˆ°è¿™äº›æœåŠ¡ï¼š

```python
# åç«¯é…ç½® (spx-knowledge-backend/.env)

# MySQL
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=user
MYSQL_PASSWORD=password
MYSQL_DATABASE=spx_knowledge

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# MinIO
MINIO_ENDPOINT=localhost:9000
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin

# OpenSearch
OPENSEARCH_HOSTS=["http://localhost:9200"]
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2024å¹´1æœˆ

